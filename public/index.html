<script>
  // TSLA Price (исправлено отображение %)
  const priceEl = document.getElementById('price');
  const changeEl = document.getElementById('change');

  async function updateTSLAPrice() {
    try {
      const proxy = 'https://corsproxy.io/?';
      const url = 'https://query1.finance.yahoo.com/v8/finance/chart/TSLA?interval=1m&range=1d';
      const res = await fetch(proxy + encodeURIComponent(url));
      const data = await res.json();
      const q = data.chart.result[0].meta;
      const price = q.regularMarketPrice.toFixed(2);
      const prev = q.previousClose.toFixed(2);
      const change = ((price - prev) / prev * 100).toFixed(2);

      priceEl.textContent = `$${price}`;
      changeEl.className = change > 0 ? 'price-change positive' : change < 0 ? 'price-change negative' : 'price-change neutral';
      changeEl.textContent = (change > 0 ? '+' + change : change) + '% (today)';
    } catch {
      priceEl.textContent = '$---.--';
      changeEl.textContent = 'No connection';
    }
  }

  updateTSLAPrice();
  setInterval(updateTSLAPrice, 30000);

  // Bull News Feed (исправлен парсинг заголовков)
  async function loadBullNews() {
    const feed = document.getElementById('news-feed');
    const query = 'Tesla (stock rise OR Optimus OR Robotaxi OR FSD success OR Cybertruck ramp OR record deliveries OR battery breakthrough OR Elon Musk Tesla positive)';
    const rssUrl = `https://news.google.com/rss/search?q=${encodeURIComponent(query)}&hl=en-US&gl=US&ceid=US:en`;
    const proxyUrl = 'https://corsproxy.io/?' + encodeURIComponent(rssUrl);

    try {
      const res = await fetch(proxyUrl);
      const text = await res.text();
      const xml = new DOMParser().parseFromString(text, "text/xml");
      const items = xml.querySelectorAll("item");
      feed.innerHTML = '';
      let count = 0;
      items.forEach(item => {
        if (count >= 15) return;
        const titleEl = item.getElementsByTagName("title")[0];
        const linkEl = item.getElementsByTagName("link")[0];
        const pubDateEl = item.getElementsByTagName("pubDate")[0];

        const title = titleEl ? titleEl.textContent.trim() : 'Bull News';
        const link = linkEl ? linkEl.textContent.trim() : '#';
        const date = pubDateEl ? new Date(pubDateEl.textContent).toLocaleDateString('en-GB') : 'Recent';

        feed.innerHTML += `<div class="news-item">
          <div class="news-title"><a href="\( {link}" target="_blank"> \){title}</a></div>
          <div class="news-date">${date}</div>
        </div>`;
        count++;
      });
    } catch {
      feed.innerHTML = '<div class="news-item" style="text-align:center;color:#aaa;">News loading...</div>';
    }
  }

  loadBullNews();
</script>
